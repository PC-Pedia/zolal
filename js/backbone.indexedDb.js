/* Backbone IndexedDb 0.0.13 */
(function(){function a(){return((1+Math.random())*65536|0).toString(16).substring(1)}function b(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function h(a,b,c){this.schema=a,this.ready=b,this.error=null,this.transactions=[],this.db=null,this.nolog=c,this.supportOnUpgradeNeeded=!1;var f=d.last(this.schema.migrations).version;this.nolog||i("opening database "+this.schema.id+" in version #"+f),this.dbRequest=e.open(this.schema.id,f),this.launchMigrationPath=function(b){var c=this.dbRequest.transaction||versionRequest.result,e=d.clone(a.migrations);this.migrate(c,e,b,{success:function(){this.ready()}.bind(this),error:function(){this.error="Database not up to date. "+b+" expected was "+f}.bind(this)})},this.dbRequest.onblocked=function(a){this.nolog||i("blocked")},this.dbRequest.onsuccess=function(a){this.db=a.target.result;if(!this.supportOnUpgradeNeeded){var b=parseInt(this.db.version)||0,c=parseInt(f)||0;b===c?this.ready():b<c?this.launchMigrationPath(b):this.error="Database version is greater than current code "+b+" expected was "+c}}.bind(this),this.dbRequest.onerror=function(a){this.error="Couldn't not connect to the database"}.bind(this),this.dbRequest.onabort=function(a){this.error="Connection to the database aborted"}.bind(this),this.dbRequest.onupgradeneeded=function(a){this.db=a.target.transaction.db,this.supportOnUpgradeNeeded=!0,this.nolog||i("onupgradeneeded = "+a.oldVersion+" => "+a.newVersion),this.launchMigrationPath(a.oldVersion)}.bind(this)}function i(a){typeof window!="undefined"&&typeof window.console!="undefined"&&typeof window.console.log!="undefined"?window.console.log(a):console.log!=="undefined"&&console.log(a)}function j(a,b,c){this.driver=new h(a,this.ready.bind(this),c),this.started=!1,this.stack=[],this.version=d.last(a.migrations).version,this.next=b}function l(a,b,e){if(a=="closeall"){d.each(k,function(a){a.close()}),k={};return}if(typeof b.database=="undefined"&&typeof c.ajaxSync=="function")return c.ajaxSync(a,b,e);var f=b.database;k[f.id]&&k[f.id].version!=d.last(f.migrations).version&&(k[f.id].close(),delete k[f.id]);var g,h=function(){};if(typeof $!="undefined"&&$.Deferred){var i=$.Deferred(),l=i.resolve,m=i.reject;g=i.promise()}else var l=h,m=h;var n=e.success;e.success=function(a){n&&n(a),l(),b.trigger("sync",b,a,e)};var o=e.error;e.error=function(a){o&&o(a),m(),b.trigger("error",b,a,e)};var p=function(){k[f.id].execute([a,b,e])};return k[f.id]?p():k[f.id]=new j(f,p,f.nolog),g}var c,d;typeof exports!="undefined"?(d=require("underscore"),c=require("backbone")):(d=window._,c=window.Backbone);var e=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,f=window.IDBTransaction||window.webkitIDBTransaction||{READ_WRITE:"readwrite"},g=window.IDBKeyRange||window.webkitIDBKeyRange;window.IDBCursor=window.IDBCursor||window.webkitIDBCursor||window.mozIDBCursor||window.msIDBCursor,h.prototype={_track_transaction:function(a){function b(){var b=this.transactions.indexOf(a);b!==-1&&this.transactions.splice(b)}this.transactions.push(a),a.oncomplete=b.bind(this),a.onabort=b.bind(this),a.onerror=b.bind(this)},migrate:function(a,b,c,d){this.nolog||i("migrate begin version from #"+c);var e=this,f=b.shift();f&&(!c||c<f.version?(typeof f.before=="undefined"&&(f.before=function(a){a()}),typeof f.after=="undefined"&&(f.after=function(a){a()}),this.nolog||i("migrate begin before version #"+f.version),f.before(function(){this.nolog||i("migrate done before version #"+f.version);var g=function(g){this.nolog||i("migrate begin migrate version #"+f.version),f.migrate(a,function(){this.nolog||i("migrate done migrate version #"+f.version),this.nolog||i("migrate begin after version #"+f.version),f.after(function(){this.nolog||i("migrate done after version #"+f.version),this.nolog||i("Migrated to "+f.version),b.length==0?(this.nolog||i("migrate setting transaction.oncomplete to finish  version #"+f.version),a.oncomplete=function(){e.nolog||i("migrate done transaction.oncomplete version #"+f.version),e.nolog||i("Done migrating"),d.success()}):(this.nolog||i("migrate end from version #"+c+" to "+f.version),e.migrate(a,b,c,d))}.bind(this))}.bind(this))}.bind(this);if(!this.supportOnUpgradeNeeded){this.nolog||i("migrate begin setVersion version #"+f.version);var h=this.db.setVersion(f.version);h.onsuccess=g,h.onerror=d.error}else g()}.bind(this))):(this.nolog||i("Skipping migration "+f.version),this.migrate(a,b,c,d)))},execute:function(a,b,c,d){this.nolog||i("execute : "+b+" on "+a+" for "+c.id);switch(b){case"create":this.create(a,c,d);break;case"read":c.id||c.cid?this.read(a,c,d):this.query(a,c,d);break;case"update":this.update(a,c,d);break;case"delete":c.id||c.cid?this.delete(a,c,d):this.clear(a,c,d);break;default:}},create:function(a,c,d){var e=this.db.transaction([a],"readwrite"),f=e.objectStore(a),g=c.toJSON(),h;g.id===undefined&&!f.autoIncrement&&(g.id=b()),e.onerror=function(a){d.error(a)},e.oncomplete=function(a){d.success(g)},f.keyPath?h=f.add(g):h=f.add(g,g.id)},update:function(a,c,d){var e=this.db.transaction([a],"readwrite"),f=e.objectStore(a),g=c.toJSON(),h;g.id||(g.id=b()),f.keyPath?h=f.put(g):h=f.put(g,g.id),h.onerror=function(a){d.error(a)},e.oncomplete=function(a){d.success(g)}},read:function(a,b,c){var e=this.db.transaction([a],"readonly");this._track_transaction(e);var f=e.objectStore(a),g=b.toJSON(),h=null;if(g.id)h=f.get(g.id);else if(c.index){var i=f.index(c.index.name);h=i.get(c.index.value)}else{var j=0;d.each(f.indexNames,function(a,b){b=f.index(a);if(typeof b.keyPath=="string"&&1>j)g[b.keyPath]!==undefined&&(h=b.get(g[b.keyPath]),j=1);else if(typeof b.keyPath=="object"&&b.keyPath.length>j){var c=!0,e=d.map(b.keyPath,function(a){return c=c&&g[a]!==undefined,g[a]});c&&(h=b.get(e),j=b.keyPath.length)}})}h?(h.onsuccess=function(a){a.target.result?c.success(a.target.result):c.error("Not Found")},h.onerror=function(){c.error("Not Found")}):c.error("Not Found")},"delete":function(a,b,c){var d=this.db.transaction([a],"readwrite"),e=d.objectStore(a),f=b.toJSON(),g=e.delete(f.id);d.oncomplete=function(a){c.success(null)},g.onerror=function(a){c.error("Not Deleted")}},clear:function(a,b,c){var d=this.db.transaction([a],"readwrite"),e=d.objectStore(a),f=e.clear();f.onsuccess=function(a){c.success(null)},f.onerror=function(a){c.error("Not Cleared")}},query:function(a,b,c){var e=[],f=0,h=0,i=this.db.transaction([a],"readonly"),j=null,k=i.objectStore(a),l=null,m=null,n=null,o=null;c.conditions?d.each(k.indexNames,function(a){j||(l=k.index(a),c.conditions[l.keyPath]instanceof Array?(m=c.conditions[l.keyPath][0]>c.conditions[l.keyPath][1]?c.conditions[l.keyPath][1]:c.conditions[l.keyPath][0],n=c.conditions[l.keyPath][0]>c.conditions[l.keyPath][1]?c.conditions[l.keyPath][0]:c.conditions[l.keyPath][1],o=g.bound(m,n,!0,!0),c.conditions[l.keyPath][0]>c.conditions[l.keyPath][1]?j=l.openCursor(o,window.IDBCursor.PREV||"prev"):j=l.openCursor(o,window.IDBCursor.NEXT||"next")):c.conditions[l.keyPath]!=undefined&&(o=g.only(c.conditions[l.keyPath]),j=l.openCursor(o)))}):c.range?(m=c.range[0]>c.range[1]?c.range[1]:c.range[0],n=c.range[0]>c.range[1]?c.range[0]:c.range[1],o=g.bound(m,n),c.range[0]>c.range[1]?j=k.openCursor(o,window.IDBCursor.PREV||"prev"):j=k.openCursor(o,window.IDBCursor.NEXT||"next")):j=k.openCursor(),typeof j=="undefined"||!j?c.error("No Cursor"):(j.onerror=function(a){c.error("readCursor error",a)},j.onsuccess=function(a){var d=a.target.result;if(!d)c.addIndividually||c.clear?b.trigger("reset"):c.success(e);else if(c.limit&&h>=c.limit)o&&c.conditions[l.keyPath]?d.continue(c.conditions[l.keyPath][1]+1):d.continue();else if(c.offset&&c.offset>f)f++,d.continue();else{if(c.addIndividually)b.add(d.value);else if(c.clear){var g=k.delete(d.value.id);g.onsuccess=function(a){e.push(d.value)},g.onerror=function(a){e.push(d.value)}}else e.push(d.value);h++,d.continue()}})},close:function(){this.db&&this.db.close()}},j.prototype={ready:function(){this.started=!0,d.each(this.stack,function(a){this.execute(a)}.bind(this)),this.stack=[],this.next()},execute:function(a){this.started?this.driver.execute(a[2].storeName||a[1].storeName,a[0],a[1],a[2]):this.stack.push(a)},close:function(){this.driver.close()}};var k={};typeof exports=="undefined"?(c.ajaxSync=c.sync,c.sync=l):(exports.sync=l,exports.debugLog=i)})();
